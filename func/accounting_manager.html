<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记账管理系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.6;
        }
        header {
            background-color: #4CAF50;
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .container {
            max-width: 600px; /* 调整宽度为600px */
            margin: 40px auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .total {
            text-align: right;
            font-weight: bold;
            font-size: 20px;
            margin-top: 20px;
            color: #4CAF50;
        }
        .form-group button {
            width: 100%;
            margin-top: 10px;
        }
        .form-group-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>记账管理系统</h1>
    </header>
    <div class="container">
        <h2>添加记录</h2>
        <form id="transaction-form">
            <div class="form-group">
                <label for="date">日期:</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label for="description">描述:</label>
                <input type="text" id="description" placeholder="请输入描述" required>
            </div>
            <div class="form-group">
                <label for="amount">金额:</label>
                <input type="number" id="amount" placeholder="请输入金额" required step="0.01">
            </div>
            <div class="form-group">
                <label for="type">类型:</label>
                <select id="type" required>
                    <option value="income">收入</option>
                    <option value="expense">支出</option>
                </select>
            </div>
            <button type="submit">添加</button>
        </form>

        <h2>记录列表</h2>
        <table id="transaction-table">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>描述</th>
                    <th>金额</th>
                    <th>类型</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- 记录将显示在这里 -->
            </tbody>
        </table>

        <div class="total" id="total">总计: 0</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;

            // Load transactions from the server
            loadTransactions();
        });

        const form = document.getElementById('transaction-form');
        const tableBody = document.getElementById('transaction-table').querySelector('tbody');
        const totalDisplay = document.getElementById('total');
        let total = 0;

        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const date = document.getElementById('date').value;
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;

            const transaction = { date, description, amount, type };
            saveTransaction(transaction);
        });

        function addTransactionToTable(transaction) {
            const row = document.createElement('tr');
            const amountValue = parseFloat(transaction.amount);
            const isIncome = transaction.type === 'income';

            const dateCell = document.createElement('td');
            dateCell.textContent = transaction.date;
            row.appendChild(dateCell);

            const descriptionCell = document.createElement('td');
            descriptionCell.textContent = transaction.description;
            row.appendChild(descriptionCell);

            const amountCell = document.createElement('td');
            amountCell.textContent = amountValue.toFixed(2);
            row.appendChild(amountCell);

            const typeCell = document.createElement('td');
            typeCell.textContent = transaction.type === 'income' ? '收入' : '支出';
            row.appendChild(typeCell);

            const deleteCell = document.createElement('td');
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            deleteButton.addEventListener('click', function() {
                deleteTransaction(transaction.id)
                    .then(() => {
                        tableBody.removeChild(row);
                        total -= isIncome ? amountValue : -amountValue;
                        updateTotal();
                    })
                    .catch(error => {
                        console.error('Error deleting transaction:', error);
                        alert('删除记录时出错，请稍后再试。');
                    });
            });
            deleteCell.appendChild(deleteButton);
            row.appendChild(deleteCell);

            tableBody.appendChild(row);

            total += isIncome ? amountValue : -amountValue;
            updateTotal();
        }

        function updateTotal() {
            totalDisplay.textContent = `总计: ${total.toFixed(2)}`;
        }

        function saveTransaction(transaction) {
            fetch('/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(transaction),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                console.log('Transaction saved:', data);
                addTransactionToTable(data);
                form.reset();
            })
            .catch(error => {
                console.error('Error saving transaction:', error);
                alert('保存记录时出错，请稍后再试。');
            });
        }

        function loadTransactions() {
            fetch('/transactions')
                .then(response => response.json())
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Unexpected response');
                    }
                    tableBody.innerHTML = '';
                    total = 0;
                    data.forEach(transaction => {
                        addTransactionToTable(transaction);
                    });
                })
                .catch(error => {
                    console.error('Error loading transactions:', error);
                    alert('加载记录时出错，请稍后再试。');
                });
        }

        function deleteTransaction(id) {
            return fetch('/transactions', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                console.log('Transaction deleted:', data);
                return data;
            });
        }
    </script>
</body>
</html>
